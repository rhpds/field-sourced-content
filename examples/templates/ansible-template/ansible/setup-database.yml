---
# Optional playbook for setting up a database
# This demonstrates complex multi-component deployments

- name: Setup Database for Demo Application
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    app_name: "{{ demo_app_name | default('ansible-demo') }}"
    app_namespace: "{{ demo_namespace | default('field-content-demo') }}"
    db_name: "{{ app_name }}-db"

  tasks:
  - name: Create database secret
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Secret
        metadata:
          name: "{{ db_name }}-credentials"
          namespace: "{{ app_namespace }}"
          labels:
            app: "{{ app_name }}"
            component: database
            demo.redhat.com/application: "{{ app_name }}"
        type: Opaque
        data:
          username: "{{ 'demouser' | b64encode }}"
          password: "{{ 'demopass123' | b64encode }}"
          database: "{{ 'demodb' | b64encode }}"

  - name: Deploy PostgreSQL database
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: "{{ db_name }}"
          namespace: "{{ app_namespace }}"
          labels:
            app: "{{ app_name }}"
            component: database
            demo.redhat.com/application: "{{ app_name }}"
          annotations:
            argocd.argoproj.io/sync-wave: "1"
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: "{{ app_name }}"
              component: database
          template:
            metadata:
              labels:
                app: "{{ app_name }}"
                component: database
            spec:
              containers:
              - name: postgresql
                image: registry.redhat.io/rhel8/postgresql-13:latest
                ports:
                - containerPort: 5432
                env:
                - name: POSTGRESQL_USER
                  valueFrom:
                    secretKeyRef:
                      name: "{{ db_name }}-credentials"
                      key: username
                - name: POSTGRESQL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: "{{ db_name }}-credentials"
                      key: password
                - name: POSTGRESQL_DATABASE
                  valueFrom:
                    secretKeyRef:
                      name: "{{ db_name }}-credentials"
                      key: database
                resources:
                  requests:
                    cpu: 100m
                    memory: 256Mi
                  limits:
                    cpu: 500m
                    memory: 1Gi

  - name: Create database service
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Service
        metadata:
          name: "{{ db_name }}-service"
          namespace: "{{ app_namespace }}"
          labels:
            app: "{{ app_name }}"
            component: database
            demo.redhat.com/application: "{{ app_name }}"
          annotations:
            argocd.argoproj.io/sync-wave: "1"
        spec:
          type: ClusterIP
          ports:
          - port: 5432
            targetPort: 5432
            protocol: TCP
          selector:
            app: "{{ app_name }}"
            component: database

  - name: Wait for database to be ready
    kubernetes.core.k8s_info:
      api_version: apps/v1
      kind: Deployment
      name: "{{ db_name }}"
      namespace: "{{ app_namespace }}"
      wait_condition:
        type: Available
        status: "True"
      wait_timeout: 300

  - debug:
      msg:
        - "Database setup completed for {{ app_name }}"
        - "Database service: {{ db_name }}-service"
        - "Database port: 5432"